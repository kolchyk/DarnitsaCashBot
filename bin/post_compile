#!/bin/bash
# Post-compile script for Heroku
# This runs after the buildpack completes

set -e

echo "-----> Setting up Tesseract language data"

TESSDATA_SOURCE="./tessdata"
TESSDATA_SYSTEM="/usr/share/tesseract-ocr/5/tessdata"
TESSDATA_TARGET="./tessdata_final"

# Create target directory in app directory (writable location)
mkdir -p "$TESSDATA_TARGET"

# Copy language files from local tessdata directory if they exist
if [ -d "$TESSDATA_SOURCE" ]; then
    echo "Copying Tesseract language data files from $TESSDATA_SOURCE to $TESSDATA_TARGET..."
    for file in "$TESSDATA_SOURCE"/*.traineddata; do
        if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "  Copying $filename"
            cp "$file" "$TESSDATA_TARGET/"
        fi
    done
fi

# Copy language files from system directory (installed via apt packages)
if [ -d "$TESSDATA_SYSTEM" ]; then
    echo "Copying Tesseract language data files from $TESSDATA_SYSTEM to $TESSDATA_TARGET..."
    for lang in ukr eng rus; do
        system_file="$TESSDATA_SYSTEM/${lang}.traineddata"
        if [ -f "$system_file" ]; then
            # Only copy if not already copied from local tessdata
            if [ ! -f "$TESSDATA_TARGET/${lang}.traineddata" ]; then
                echo "  Copying ${lang}.traineddata from system"
                cp "$system_file" "$TESSDATA_TARGET/"
            else
                echo "  Skipping ${lang}.traineddata (already exists from local tessdata)"
            fi
        fi
    done
fi

echo "Language data files copied successfully"
echo "Available languages:"
ls -1 "$TESSDATA_TARGET"/*.traineddata 2>/dev/null | xargs -n1 basename | sed 's/\.traineddata$//' || echo "  (none)"
echo "TESSDATA_PREFIX will be set to: $TESSDATA_TARGET"

