# Руководство по миграциям базы данных

## Статус структуры БД

✅ **Структура базы данных корректна и не требует изменений.**

Все модели соответствуют миграциям:
- ✅ `users` - таблица пользователей
- ✅ `receipts` - таблица чеков
- ✅ `line_items` - позиции в чеках (цены используют BIGINT)
- ✅ `bonus_transactions` - транзакции бонусов (без полей Portmone)
- ✅ `catalog_items` - каталог товаров

## После очистки базы данных

Если вы очистили базу данных, нужно применить миграции для восстановления структуры.

### Вариант 1: Автоматическое применение (рекомендуется)

Heroku автоматически применяет миграции при деплое благодаря строке в `Procfile`:
```
release: alembic upgrade head
```

Просто сделайте деплой:
```bash
git push heroku main
```

### Вариант 2: Ручное применение миграций

#### Через npm скрипт (используя Heroku CLI):
```bash
node scripts/check_and_migrate_db.js
```

#### Через Heroku CLI напрямую:
```bash
# Проверить текущий статус
npx --yes heroku run alembic current --app darnitsacashbot

# Применить все миграции
npx --yes heroku run alembic upgrade head --app darnitsacashbot
```

#### Локально (если DATABASE_URL настроен):
```bash
# Проверить статус
alembic current

# Применить миграции
alembic upgrade head

# Или через Makefile
make migrate
```

## История миграций

1. **20251201_00** - Начальная схема (создает все таблицы)
2. **20251201_01** - Добавление полей Portmone (для обратной совместимости)
3. **20251202_00** - Изменение типов цен на BIGINT
4. **20251202_01** - Удаление полей Portmone (текущая версия)

## Проверка структуры БД

Для проверки структуры базы данных используйте:
```bash
python scripts/inspect_database.py
```

Или через Heroku:
```bash
npx --yes heroku run python scripts/inspect_database.py --app darnitsacashbot
```

## Важные замечания

- ⚠️ Миграции применяются автоматически при каждом деплое на Heroku
- ⚠️ Не удаляйте таблицы вручную - используйте миграции для изменений структуры
- ⚠️ Всегда проверяйте статус миграций перед важными операциями

